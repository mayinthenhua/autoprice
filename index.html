<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Price</title>
    <style>
         body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            font-size: 13px;
        }
        html, body {
            display: grid;
        }
        .col-label-1{
            background-color: lightseagreen;
        }
        .m-w-80{   
           min-width: 80px;
        }
        .scrollable-list {
            height: 400px; 
            overflow-y: auto; 
            padding: 10px;
            list-style-type: none; 
        }
        .m-select-label{
            margin: 0px 0px 0px 10px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="row" style="height: 50px;">
        <h1 class="mb-3" style="text-align: center; height: 50px; padding-bottom: 0px;">TÍNH ĐƠN GIÁ</h1>
    </div>
    <div class="row" style="margin: 0px 20px; padding-top: 20px; ">
        
        <div class="col-md-7 col-12" >
            
            <div class="card-body">
                <form>
                    <div class="row mb-3">
                        <label class="col-sm-1 col-form-label col-label-1 text-end" >HH</label>
                        <div class="col-sm-2 text-center">
                            Số lượng
                        </div>
                        <div class="col-sm-2  text-center">
                           Thuế (%)
                        </div>
                        <div class="col-sm-2  text-center">
                           Đơn giá
                        </div>
                        <label class="col-sm-1 col-form-label text-end" >±</label>
                        <div class="col-sm-2  text-center">
                            Phạm vi thay đổi giá
                        </div>
                        <div class="col-sm-2  text-center">
                           Kết quả
                        </div>
                    </div>
    
                  <div class="row mb-3">
                    <label class="col-sm-1 col-form-label col-label-1 text-end" >1</label>
                    <div class="col-sm-2">
                        <input id="quanlity1" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="taxRate1" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="price1"  class="form-control text-end m-w-80" type="text">
                    </div>
                    <label class="col-sm-1 col-form-label text-end" >±</label>
                    <div class="col-sm-2">
                        <input id="range1"  class="form-control  text-end m-w-80" type="text" >
                    </div>
                    <div class="col-sm-2">
                        <input id="result1" readonly class="form-control  bg-dark text-white text-end m-w-80" type="text" >
                    </div>
                  </div>
                  <!---->
                  <div class="row mb-3">
                    <label class="col-sm-1 col-form-label col-label-1 text-end" >2</label>
                    <div class="col-sm-2">
                        <input id="quanlity2" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="taxRate2" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="price2"  class="form-control  text-end  m-w-80" type="text">
                    </div>
                    <label class="col-sm-1 col-form-label text-end" >±</label>
                    <div class="col-sm-2">
                        <input id="range2"  class="form-control  text-end m-w-80" type="text" >
                    </div>
                    <div class="col-sm-2">
                        <input id="result2" readonly class="form-control  bg-dark text-white text-end m-w-80" type="text" >
                    </div>
                  </div>
    
                   <!---->
                   <div class="row mb-3">
                    <label class="col-sm-1 col-form-label col-label-1 text-end" >3</label>
                    <div class="col-sm-2">
                        <input id="quanlity3" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="taxRate3" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="price3"  class="form-control  text-end  m-w-80" type="text">
                    </div>
                    <label class="col-sm-1 col-form-label text-end" >±</label>
                    <div class="col-sm-2">
                        <input id="range3"  class="form-control  text-end m-w-80" type="text" >
                    </div>
                    <div class="col-sm-2">
                        <input id="result3" readonly class="form-control  bg-dark text-white text-end m-w-80" type="text" >
                    </div>
                  </div>
                  <!---->
                  <div class="row mb-3">
                    <label class="col-sm-1 col-form-label col-label-1 text-end" >4</label>
                    <div class="col-sm-2">
                        <input id="quanlity4" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="taxRate4" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="price4"  class="form-control  text-end  m-w-80" type="text">
                    </div>
                    <label class="col-sm-1 col-form-label text-end" >±</label>
                    <div class="col-sm-2">
                        <input id="range4"  class="form-control  text-end m-w-80" type="text" >
                    </div>
                    <div class="col-sm-2">
                        <input id="result4" readonly class="form-control  bg-dark text-white text-end m-w-80" type="text" >
                    </div>
                  </div>
                  <!---->
                  <div class="row mb-3">
                    <label class="col-sm-1 col-form-label col-label-1 text-end" >5</label>
                    <div class="col-sm-2">
                        <input id="quanlity5" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="taxRate5" class="form-control text-center m-w-80" type="text">
                    </div>
                    <div class="col-sm-2">
                        <input id="price5"  class="form-control  text-end  m-w-80" type="text">
                    </div>
                    <label class="col-sm-1 col-form-label text-end" >±</label>
                    <div class="col-sm-2">
                        <input id="range5"  class="form-control  text-end m-w-80" type="text" >
                    </div>
                    <div class="col-sm-2">
                        <input id="result5" readonly class="form-control bg-dark text-white text-end m-w-80" type="text" >
                    </div>
                  </div>
                  <hr>
                  <div  class="row mb-3">
                    <label class="col-sm-8 col-form-label text-end" >Giá trị hóa đơn mong muốn</label>
                    <div class="col-sm-4">
                        <input id="total"  class="form-control text-end" type="text" style="border-color: red;" >
                    </div>
                  </div>
                  <div id="total-range" class="text-end">
                    
                  </div>
                  
                  <div  class="row mb-3">
                   <!--<label class="col-sm-4 col-form-label d-none text-end" >Thời gian tìm kết quả:</label>
                    <div class="col-sm-3 d-none">
                        <input id="input-timeout"  class="form-control" type="text" >
                    </div>
                    
                    <label class="col-sm-2 col-form-label" >Tốc độ:</label>
                    <div class="col-sm-3">
                        <input id="input-speed"  class="form-control" type="text" >
                    </div>
                    --> 
                  </div>
                  
    
                </form>
            </div>
        </div>
        <div class="col-md-5  col-12">
            <div class="card-body" >
                <div class="row  text-center">
                    <div class="col-sm-8 d-flex justify-content-start">
                        <button id="btnResult" type="button" class="btn btn-primary" style="margin: 0px 15px; width: 200px;">
                            <span id="loading-result" class="spinner-border spinner-border-sm d-none"></span>
                            Tìm kết quả
                        </button>
                        
                    </div>
                    
                    <label class="col-sm-2 col-form-label text-end" >Tốc độ:</label>
                    <div class="col-sm-2">
                        <input id="input-speed"  class="form-control" type="text" >
                    </div>
                  </div>
                  <hr>
                  <div class="mt-3" >
                    <div id="invalid-value" class=" d-none">
                        <strong style="color: red;">Không tìm thấy kết quả hợp lệ.</strong> 
                        <br>
                        <span id="invalid-message"></span>
                        
                    </div>
                    <ul id="list-result" class="list-group scrollable-list" >
                        
                    </ul>
                    
                  </div>
                  <hr>
            </div>
        </div>
    </div>

    
<script>
    function parseNumber(value) {
        return  parseInt(value.replace(/,/g, '',10));
    }
    function formatNumber(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Lắng nghe sự kiện trên tất cả các input có type=text
        document.querySelectorAll('input[type="text"]').forEach(function(input) {
            input.addEventListener('keypress', function(e) {
                if (e.key !== '.' && (e.key < '0' || e.key > '9')) {
                    e.preventDefault();
                }
            });
            input.addEventListener('input', function(e) {
                // Lấy giá trị số hiện tại (bỏ dấu phẩy)
                let value = e.target.value.replace(/,/g, '');

                // Kiểm tra nếu là số hợp lệ
                if (!isNaN(value) && value !== "") {
                    // Định dạng lại giá trị với dấu phân cách
                   // e.target.value = formatNumber(value);
                } else {
                    e.target.value = value; // Giữ nguyên giá trị nếu không hợp lệ
                }
            });

            // Khi người dùng focus vào input, xóa dấu phân cách để chỉnh sửa dễ dàng
            input.addEventListener('focus', function(e) {
                e.target.value = e.target.value.replace(/,/g, '');
                e.target.select();
            });

            // Khi người dùng blur, thêm lại dấu phân cách
            input.addEventListener('blur', function(e) {
                let value = e.target.value.replace(/,/g, '');
                if (!isNaN(value) && value !== "") {
                    e.target.value = formatNumber(value);
                }
            });
        });
</script>
<script>
    $(document).ready(function(){
        
        $('#quanlity1').val(1);
        $('#taxRate1').val(8);
        $('#price1').val( formatNumber(1550000) );
        $('#range1').val(formatNumber(10000));

        $('#quanlity2').val(0);
        $('#taxRate2').val(8);
        $('#price2').val(formatNumber(0));
        $('#range2').val(formatNumber(0));

        $('#quanlity3').val(0);
        $('#taxRate3').val(10);
        $('#price3').val(formatNumber(0));
        $('#range3').val(0);

        $('#quanlity4').val(0);
        $('#taxRate4').val(10);
        $('#price4').val(0);
        $('#range4').val(0);

        $('#quanlity5').val(0);
        $('#taxRate5').val(10);
        $('#price5').val(0);
        $('#range5').val(0);
        $('#total').val(formatNumber(0));
      //  $('#input-timeout').val(formatNumber(3000));
        $('#input-speed').val(20);
    $('#btnResult').click(function(){
        
        let hh =[];
        let quanlity1 = parseNumber( $('#quanlity1').val(),10); 
        let taxRate1 =parseNumber($('#taxRate1').val(),10);
        let price1 =parseNumber($('#price1').val(),10);
        let range1 =parseNumber($('#range1').val(),10);
        hh.push({
                    quanlity:quanlity1,
                    price:price1,
                    range:range1,
                    taxRate:taxRate1   
                });

        let quanlity2 =  parseNumber($('#quanlity2').val(),10);
        let taxRate2 =parseNumber($('#taxRate2').val(),10);
        let price2 =parseNumber($('#price2').val(),10);
        let range2 =parseNumber($('#range2').val(),10);
        hh.push({
                quanlity:quanlity2,
                price:price2,
                range:range2,
                taxRate:taxRate2   
            });

        let quanlity3 = parseNumber( $('#quanlity3').val(),10);
        let taxRate3 =parseNumber($('#taxRate3').val(),10);
        let price3 =parseNumber($('#price3').val(),10);
        let range3 =parseNumber($('#range3').val(),10);
        hh.push({
                quanlity:quanlity3,
                price:price3,
                range:range3,
                taxRate:taxRate3   
            });

        let quanlity4 = parseNumber( $('#quanlity4').val(),10);
        let taxRate4 =parseNumber($('#taxRate4').val(),10);
        let price4 =parseNumber($('#price4').val(),10);
        let range4 =parseNumber($('#range4').val(),10);
        hh.push({
                quanlity:quanlity4,
                price:price4,
                range:range4,
                taxRate:taxRate4   
            });

        let quanlity5 = parseNumber( $('#quanlity5').val(),10);
        let taxRate5 =parseNumber($('#taxRate5').val(),10);
        let price5 =parseNumber($('#price5').val(),10);
        let range5 =parseNumber($('#range5').val(),10);

        hh.push({
                quanlity:quanlity5,
                price:price5,
                range:range5,
                taxRate:taxRate5   
            });
        let total =parseNumber($('#total').val(),10);
        let timeout =6000;//parseNumber($('#input-timeout').val(),10);
        let step =parseNumber($('#input-speed').val(),10);
        let resultRange = [];
        let isTimeout=false;
        
        $('#list-result').empty();
        $('#result1').val('');
        $('#result2').val('');
        $('#result3').val('');
        $('#result4').val('');
        $('#result5').val('');
        const startTime = Date.now();
        try {
            //region min---max value
            let min_taxVal=0;
            let min_sub =0;
            let max_taxVal = 0;
            let max_sub = 0;
            for(let i=0; i<5;i++){
                let min_sub_i = hh[i].quanlity * (hh[i].price - hh[i].range);
                let min_taxVal_i = min_sub_i * hh[i].taxRate / 100;
                min_taxVal += min_taxVal_i;
                min_sub +=min_sub_i;
                //====
                let max_sub_i = hh[i].quanlity * (hh[i].price + hh[i].range);
                let max_taxVal_i = max_sub_i * hh[i].taxRate / 100;
                max_taxVal += max_taxVal_i;
                max_sub+=max_sub_i;
            }
            min_taxVal = Math.round(min_taxVal);
            let min_val = min_sub + min_taxVal;

            max_taxVal = Math.round(max_taxVal);
            let max_val = max_sub + max_taxVal;
            //=================
            // let min_sub1 = hh[0].quanlity * (hh[0].price - hh[0].range);
            // let min_taxVal1 = min_sub1 * hh[0].taxRate / 100;
            // let max_sub1 = hh[0].quanlity * (hh[0].price + hh[0].range);
            // let max_taxVal1 = max_sub1 * hh[0].taxRate / 100;
            // let min_val_2_5 = min_val - (min_sub1 + Math.round(min_taxVal1));
            // let max_val_2_5 = max_val - (max_sub1 + Math.round(max_taxVal1));
            displayInvalidMessage(false);
        //end region
            // let current_sub1 = quanlity1 * price1;
            // let current_taxVal1 = current_sub1 * taxRate1 / 100;
            // let current_sub2 = quanlity2 * price2;
            // let current_taxVal2 = current_sub2* taxRate2 / 100;
            // let current_sub3 = quanlity3 * price3;
            // let current_taxVal3 = current_sub3 * taxRate3 / 100;
            // let current_sub4 = quanlity4 * price4;
            // let current_taxVal4 = current_sub4 * taxRate4 / 100;
            // let current_sub5 = quanlity5 * price5;
            // let current_taxVal5 = current_sub5 * taxRate5 / 100;
            // let current_taxVal = current_taxVal1 + current_taxVal2 + current_taxVal3 + current_taxVal4 + current_taxVal5;
            // current_taxVal = Math.round(current_taxVal);
            // let current_sub = current_sub1 + current_sub2 + current_sub3 + current_sub4 + current_sub5;
            // let current_val = current_sub + current_taxVal;
            
            //================
            $('#loading-result').removeClass('d-none');
            
            setRangeValueMessage(min_val,max_val,total);
            if(total<=0){
                displayInvalidMessage(true);
                totalInvalidMsg();
                $('#loading-result').addClass('d-none');
                return;
            }
            if(total<min_val || total>max_val){
                displayInvalidMessage(true);
                $('#loading-result').addClass('d-none');
                
                return;
            }
            
            
            setTimeout(() => {
                let maxNumber = price1 + range1;
                let minNumber = price1 - range1;
                let numWorkers = range1*2>=100 && range1*2<=1000? Math.ceil( range1*2/20):range1*2>1000?Math.ceil( range1*2/100):1;
               console.log('numWorkers',numWorkers);
                const segmentSize = Math.ceil(range1*2 / numWorkers);
                console.log('segmentSize',segmentSize);
                const workers = [];
                let completedWorkers = 0;
                for (let i = 0; i < numWorkers; i++) {
                    workers[i] = new Worker('worker.js');

                    workers[i].onmessage = function(event) {
                        completedWorkers++;
                        console.log(`Worker ${i} finished processing:`, event.data);
                        resultRange[i] = event.data;
                        
                         if(completedWorkers===numWorkers){
                            let allresult = resultRange.flat();
                            if(allresult.length<1){
                                displayInvalidMessage(true);
                            }else{
                                for (let i = 0; i < resultRange.length; i++) {

                                    $('#list-result').append(
                                        `<li class="list-group-item">
                                            HH1: <strong>${formatNumber(resultRange[i].x)}</strong> 
                                            -HH2: <strong>${formatNumber(resultRange[i].y)}</strong> 
                                            -HH3: <strong>${formatNumber(resultRange[i].z)}</strong> 
                                            -HH4: <strong>${formatNumber(resultRange[i].u)}</strong> 
                                            -HH5: <strong>${formatNumber(resultRange[i].v)}</strong>
                                        </li>`);
                                    
                                }
                            }
                            $('#loading-result').addClass('d-none');  
                         }                 
                      
                    };

                    const start = minNumber + i * segmentSize;
                    const end =minNumber + (i + 1) * segmentSize;
                    
                    // Gửi phân đoạn cho worker xử lý
                    workers[i].postMessage({ start, end, total,step,hh });
                }
                // for (let x = price1,xx=0,xxx=true; xx<=range1*2 && !isTimeout; xx += step,xxx=!xxx) {
                //     if(xxx){
                //         x = x + xx;
                //     }else{
                //         x = x + xx*(-1);
                //     }

                // }
                
            }, 100);
           
          
        } catch (error) {
            console.log(error);
            $('#loading-result').addClass('d-none');
        }
       
    });
        
       $(document).on('click','#list-result li',function(){
            try {
                let selectedItemText = $(this).text();
                let items = selectedItemText.split('-');
                let hh1 = items[0].split(':')[1].trim();
                let hh2 = items[1].split(':')[1].trim();
                let hh3 = items[2].split(':')[1].trim();
                let hh4 = items[3].split(':')[1].trim();
                let hh5 = items[4].split(':')[1].trim();
                $('#result1').val(hh1);
                $('#result2').val(hh2);
                $('#result3').val(hh3);
                $('#result4').val(hh4);
                $('#result5').val(hh5);
            } catch (error) {
                
            }
            
       });
    
});

</script>
<script>
    
    function displayInvalidMessage(isdisplay){
        
        if(isdisplay){

            $('#invalid-value').removeClass('d-none');
        }else{
            $('#invalid-value').addClass('d-none');
        }
    }
    function setRangeValueMessage(min,max,value){
        if(value<min){
            $('#invalid-message').html(`Vui lòng giảm số lượng hoặc đơn giá. <br> Cần giảm khoảng ${formatNumber(min-value)}`);
            $('#total-range').html(`Giá trị tìm được khoảng: <i style='color:red;' class="bi bi-file-arrow-down-fill"></i>... <strong> ${formatNumber(min)} ... ${formatNumber(max)}</strong> <br> Lớn hơn giá trị mong muốn.`);
        }
        else if(value > max){
            $('#invalid-message').html(`Vui lòng tăng số lượng hoặc đơn giá. <br>Cần tăng khoảng ${formatNumber(value-max)}`);
            $('#total-range').html(`Giá trị tìm được khoảng: <strong> ${formatNumber(min)} ... ${formatNumber(max)}</strong>...<i style='color:red;' class="bi bi-file-arrow-down-fill"></i>  <br> Nhỏ hơn giá trị mong muốn.`);

        }
        else{
            $('#invalid-message').html('Vui lòng giảm tốc độ hoặc thay đổi giá trị khác cho phù hợp.');
            $('#total-range').html(`Giá trị tìm được khoảng: <strong> ${formatNumber(min)} ...<i style='color:red;' class="bi bi-file-arrow-down-fill"></i>... ${formatNumber(max)}</strong> `);
        }
    }
    function timeoutMsg(calculatedTotalCurrent){
        $('#invalid-message').html(`Thời gian tính quá lâu. Kết quả chỉ được tính tới:${formatNumber(calculatedTotalCurrent)} <br> Thử tăng tốc độ lên`);
    }
    function totalInvalidMsg(){
        $('#invalid-message').html(`Chưa cài đặt giá trị hóa đơn mong muốn.`);
    }

</script>
</body>
</html>